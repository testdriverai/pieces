version: 6.0.11
session: 67f00511acbd9ccac373edf7
steps:
  - prompt: install pfd
    commands:
      - command: exec
        lang: pwsh
        timeout: 300000
        code: |
            # Re-define variables and function for this command block
            $appInstallerUrl = "https://builds.pieces.app/stages/staging/pieces_for_x/windows-exe/download"
            $appInstallerPath = "$env:USERPROFILE\Downloads\pieces_for_x.exe"
            
            function Install-Application($installerUrl, $installerPath, $appName, $silentArgs) {
              Write-Host "$(Get-Date -Format G): Starting download of $appName installer..."
              # Create WebClient object
              $webClient = New-Object System.Net.WebClient
              $progressEvent = Register-ObjectEvent -InputObject $webClient -EventName DownloadProgressChanged -Action {
                $percent = $EventArgs.ProgressPercentage
                Write-Host "$(Get-Date -Format G): Downloading $($using:appName) - $percent% complete"
              }

              # Download file asynchronously
              $webClient.DownloadFileAsync($installerUrl, $installerPath)
              while ($webClient.IsBusy) {
                Start-Sleep -Milliseconds 500
              }

              Unregister-Event -SourceIdentifier $progressEvent.Name
              Remove-Job -Name $progressEvent.Name
              Write-Host "$(Get-Date -Format G): $appName installer download complete."
              if (Test-Path $installerPath) {
                Write-Host "$(Get-Date -Format G): Running the $appName installer..."
                Start-Process -FilePath $installerPath -ArgumentList $silentArgs -Wait
                Start-Sleep -Seconds 10
              } else {
                Write-Host "$(Get-Date -Format G): Failed to download the $appName installer."
              }
            }
            
            # Download and install Pieces Desktop (staging)
            Install-Application $appInstallerUrl $appInstallerPath "Pieces Desktop" "/SILENT"

      - command: exec
        lang: pwsh
        timeout: 300000
        code: |
            
            Write-Host "$(Get-Date -Format G): Attempting to start the Pieces application..."
            $piecesExePath = "C:\Program Files\Pieces for Developers\pieces_for_x.exe"

            if (Test-Path $piecesExePath) {
              Start-Process -FilePath $piecesExePath
              Write-Host "$(Get-Date -Format G): Pieces application started successfully."
            } else {
              Write-Host "$(Get-Date -Format G): Failed to find the Pieces application executable."
            }

      - command: wait-for-text
        text: Pieces
        timeout: 10000
